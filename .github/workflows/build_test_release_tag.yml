name: Build, Test & Release Tag (Maven)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options: [patch, minor, major]
        default: patch
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write
  pull-requests: write
  checks: write
  security-events: write

env:
  JAVA_DISTRIBUTION: temurin
  JAVA_VERSION: "17"
  MAVEN_OPTS: -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

jobs:
  build_test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build & Test with Maven
        run: |
          mvn -T 1C --batch-mode clean verify $MAVEN_OPTS

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maven-build
          path: target/*.jar

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/*
            **/target/failsafe-reports/*

      - name: Generate SBOM (CycloneDX)
        run: |
          mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom -DskipTests
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom
          path: target/bom.xml

      - name: OWASP Dependency-Check
        uses: dependency-check/Action@v1.1.0
        with:
          project: "ORCID-Source"
          path: "."
          format: "HTML"
          args: >
            --scan . --failOnCVSS 7
        continue-on-error: false

      - name: Upload Dependency-Check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: depcheck
          path: |
            dependency-check-report.html
            dependency-check-report.xml
          if-no-files-found: warn

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - uses: github/codeql-action/init@v3
        with:
          languages: java
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  release_tag:
    name: Create Release Tag & Publish
    runs-on: ubuntu-latest
    needs: [build_test]
    if: ${{ github.ref == 'refs/heads/main' && success() }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version & create tag
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current version: $VERSION"
          mvn build-helper:parse-version versions:set \
            -DnewVersion=\${parsedVersion.${{ github.event.inputs.bump }}Version}
          NEW_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "New version: $NEW_VERSION"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -am "Release $NEW_VERSION"
          git tag v$NEW_VERSION
          git push origin v$NEW_VERSION
          git push
          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV

      - name: Draft Release Notes
        id: release_notes
        uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.new_version }}
          name: Release v${{ env.new_version }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: false
          files: |
            target/*.jar
            target/bom.xml
            dependency-check-report.html

  summary:
    name: PR Summary & Auto-Approval
    runs-on: ubuntu-latest
    needs: [build_test, codeql]
    steps:
      - name: Post PR Comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: build-test-release-summary
          message: |
            ☕ **Build, Test & Release Tag**
            - Build & tests: ✅ completed
            - SBOM: CycloneDX generated
            - OWASP Dependency-Check: ❌ fails if CVSS ≥ 7
            - CodeQL: analysis posted to Security tab
            - Release tag + GitHub Release: auto-created on `main` with changelog

      - name: Auto-approve PR if all checks passed
        if: ${{ github.event_name == 'pull_request' && success() }}
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
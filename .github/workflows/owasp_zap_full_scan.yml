name: OWASP ZAP Full Scan

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target URL to scan"
        required: true
        default: "http://localhost:8080"
  pull_request:

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  security-events: write

jobs:
  zap_scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP ZAP Full Scan
        id: zap
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: ${{ github.event.inputs.target }}
          cmd_options: "-a -j -m 5"
          allow_issue_writing: false
          issue_title: "OWASP ZAP Full Scan Report"

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report.html

      - name: Create GitHub Issues for Vulnerabilities
        if: failure() # spust√≠ se jen pokud scan sel≈æe (kritick√© n√°lezy)
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "OWASP ZAP Vulnerabilities Detected"
          content-filepath: report.html
          labels: security, vulnerability

  summary:
    name: PR Summary & Auto-Approval
    runs-on: ubuntu-latest
    needs: zap_scan
    steps:
      - name: Post PR Comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: zap-summary
          message: |
            üîí **OWASP ZAP Full Scan**
            - Target: `${{ github.event.inputs.target }}`
            - Report uploaded as artifact (`report.html`)
            - ‚ùå PR blocked if critical vulnerabilities found
            - üìù GitHub Issues auto-created for HIGH/CRITICAL findings

      - name: Auto-approve PR if all checks passed
        if: ${{ github.event_name == 'pull_request' && success() }}
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
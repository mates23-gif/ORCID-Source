name: Pull Request CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

env:
  JAVA_DISTRIBUTION: temurin
  JAVA_VERSION: "17"
  MAVEN_OPTS: -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

jobs:
  build_test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Build & Test
        run: mvn -T 1C --batch-mode clean verify $MAVEN_OPTS

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/*
            **/target/failsafe-reports/*

  lint:
    name: Lint & Style
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Spotless (Java auto-fix)
        run: |
          mvn spotless:apply
          mvn spotless:check

      - name: Prettier (YAML/Markdown auto-fix)
        run: |
          npm install -g prettier
          prettier --write "**/*.yml" "**/*.yaml" "**/*.md"

      - name: Commit auto-fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: auto-fix lint issues" || echo "No changes to commit"
          git push || echo "No push (fork or no changes)"

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OWASP Dependency-Check
        uses: dependency-check/Action@v1.1.0
        with:
          project: "ORCID-Source"
          path: "."
          format: "HTML"
          args: "--scan . --failOnCVSS 7"

      - name: Upload Dependency-Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: depcheck
          path: |
            dependency-check-report.html
            dependency-check-report.xml

      - name: Generate SBOM (CycloneDX)
        run: mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom -DskipTests
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom
          path: target/bom.xml

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: java
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  summary:
    name: PR Summary & Auto-Approval
    runs-on: ubuntu-latest
    needs: [build_test, lint, security]
    steps:
      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-summary
          message: |
            âœ… **Pull Request CI Summary**
            - Build & tests: completed
            - Lint & style: auto-fixed via Spotless/Prettier
            - Security: Dependency-Check, SBOM, CodeQL
            - Reports uploaded as artifacts

      - name: Auto-approve PR if all checks passed
        if: success()
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
name: Seed Maven, Docker & Node.js Cache

on:
  workflow_dispatch:   # manuální spuštění
  push:
    branches: [ main ] # volitelně i při pushi na main

permissions:
  contents: read
  security-events: write

jobs:
  seed-cache:
    name: Seed Maven, Docker & Node.js Cache
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Maven cache
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Download Maven Dependencies (root)
        run: mvn dependency:go-offline --batch-mode

      - name: Download Maven Dependencies (all modules)
        run: |
          for pom in $(find . -name "pom.xml"); do
            echo "Seeding cache for $pom"
            mvn -f "$pom" dependency:go-offline --batch-mode
          done

      - name: Verify Maven Cache Warmup
        run: mvn dependency:resolve --batch-mode

      # Docker cache
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Seed Docker Base Images
        run: |
          for dockerfile in $(find . -name "Dockerfile"); do
            echo "Seeding cache for $dockerfile"
            base=$(grep -i "^FROM" "$dockerfile" | awk '{print $2}')
            if [ -n "$base" ]; then
              echo "Pulling base image: $base"
              docker pull "$base" || true
            fi
          done

      - name: Build Docker Images (cache only)
        run: |
          for dockerfile in $(find . -name "Dockerfile"); do
            echo "Building image for $dockerfile"
            docker build -f "$dockerfile" --cache-from=type=registry --tag seed-cache-test .
          done

      # Node.js cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Node.js Dependencies
        run: npm ci

      - name: Verify Node.js Cache Warmup
        run: npm ls --depth=0
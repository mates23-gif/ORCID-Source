name: Maven Build, Test & Security (Full Matrix + Summary)

on:
  push:
    branches: [ main, develop ]
  pull_request:

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  MAVEN_OPTS: -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

jobs:
  build_test:
    name: Build & Test (Java ${{ matrix.java }} / Maven ${{ matrix.maven }} / ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [17, 21]
        maven: [3.8.8, 3.9.9]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: maven

      - name: Setup Maven ${{ matrix.maven }}
        uses: s4u/setup-maven-action@v1.6.0
        with:
          maven-version: ${{ matrix.maven }}

      - name: Build & Run Tests
        run: mvn -T 1C --batch-mode clean verify $MAVEN_OPTS

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-java-${{ matrix.java }}-maven-${{ matrix.maven }}-${{ matrix.os }}
          path: |
            **/target/surefire-reports/*
            **/target/failsafe-reports/*

  dependency_check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      - uses: dependency-check/Action@v1.1.0
        with:
          path: "."
          format: "SARIF"
          args: "--scan . --failOnCVSS 7"
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: dependency-check-report.sarif

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      - name: Generate CycloneDX SBOM
        run: mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom -DskipTests
      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: target/bom.xml

  trivy_scan:
    name: Trivy FS & Config Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs,config
          severity: HIGH,CRITICAL
          vuln-type: os,library
          format: sarif
          output: trivy.sarif
          exit-code: "0"
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy.sarif

  summary:
    name: Security & Test Summary
    runs-on: ubuntu-latest
    needs: [build_test, dependency_check, sbom, trivy_scan]
    steps:
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ci-summary
          message: |
            ✅ **CI Summary**
            - Build & Tests: Matrix (Java 17/21, Maven 3.8/3.9, Ubuntu/Windows/macOS) → ✅
            - OWASP Dependency-Check: ✅ (fail ≥ CVSS 7)
            - SBOM (CycloneDX): ✅ generated
            - Trivy FS/Config: ✅ scanned (HIGH/CRITICAL reported in Security tab)
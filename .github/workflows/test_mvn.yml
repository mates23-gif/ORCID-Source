name: Test, Security & SBOM (Maven)

on:
  workflow_dispatch:
  workflow_call:
  pull_request:

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  security-events: write

env:
  JAVA_DISTRIBUTION: temurin
  MAVEN_OPTS: -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

jobs:
  test_matrix:
    name: Maven tests & security
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - orcid-message-listener
          - orcid-activemq
          - orcid-api-web
          - orcid-internal-api
          - orcid-pub-web
          - orcid-scheduler-web
          - orcid-web
          - orcid-utils
          - orcid-core
          - orcid-persistence
          - orcid-api-common
        java: [17, 21]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ matrix.java }}
          cache: maven

      - name: Run tests
        run: |
          mvn -T 1C --batch-mode test \
            $MAVEN_OPTS \
            --projects ${{ matrix.project }} \
            --fail-at-end

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ matrix.project }}-jdk${{ matrix.java }}
          path: |
            **/target/surefire-reports/*
            **/target/failsafe-reports/*

      - name: Generate SBOM (CycloneDX)
        run: |
          mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom -DskipTests
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-${{ matrix.project }}-jdk${{ matrix.java }}
          path: target/bom.xml

      - name: OWASP Dependency-Check
        uses: dependency-check/Action@v1.1.0
        with:
          project: "ORCID-${{ matrix.project }}"
          path: "."
          format: "HTML"
          args: >
            --scan . --failOnCVSS 7
        # ❌ Build selže pokud najde CVSS ≥ 7
        continue-on-error: false

      - name: Upload Dependency-Check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: depcheck-${{ matrix.project }}-jdk${{ matrix.java }}
          path: |
            dependency-check-report.html
            dependency-check-report.xml
          if-no-files-found: warn

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: 17
          cache: maven
      - uses: github/codeql-action/init@v3
        with:
          languages: java
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  dependency_review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: actions/dependency-review-action@v4

  summary:
    name: PR Summary & Auto-Approval
    runs-on: ubuntu-latest
    needs: [test_matrix, codeql, dependency_review]
    steps:
      - name: Create summary
        run: |
          echo "## ✅ Build & Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Maven tests ran for all modules on JDK 17 & 21" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM (CycloneDX) generated per module" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency-Check reports uploaded (build fails if CVSS ≥ 7)" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Review executed for PRs" >> $GITHUB_STEP_SUMMARY

      - name: Post PR Comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-security-summary
          message: |
            ✅ **Tests & Security Checks Completed**
            - Maven tests: all modules, JDK 17 & 21
            - SBOM: CycloneDX generated
            - OWASP Dependency-Check: reports attached (❌ build fails if CVSS ≥ 7)
            - CodeQL: analysis posted to Security tab
            - Dependency Review: executed

      - name: Auto-approve PR if all checks passed
        if: ${{ github.event_name == 'pull_request' && success() }}
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}